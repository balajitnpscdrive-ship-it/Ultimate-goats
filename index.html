<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DON BOSCO G.O.A.T.S</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&family=Great+Vibes&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bosco: #ff0055; --savio: #00d4ff; --ruva: #ffcc00; --thomas: #00ff88; --neon: #fbff00; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: #000 no-repeat center fixed; background-size: cover; color: white; min-height: 100vh; }
        .glass { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 15px; margin: 10px; }
        .header { display: flex; flex-direction: column; align-items: center; padding: 15px; border-bottom: 2px solid var(--savio); background: rgba(0,0,0,0.9); position: sticky; top: 0; z-index: 100; }
        .logo-img { height: 45px; } .founder-img { height: 50px; width: 50px; border-radius: 50%; border: 2px solid var(--neon); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #1a1a1a; color: white; border: 1px solid #333; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        .session-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; }
        .session-box { padding: 8px 2px; border-radius: 8px; font-size: 11px; font-weight: bold; color: #000; text-align: center; }
        .btn-main { width: 100%; padding: 16px; border-radius: 12px; background: var(--neon); color: black; font-weight: 900; border: none; cursor: pointer; margin-top: 10px; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--neon); }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--neon); color: black; padding: 12px 25px; border-radius: 50px; display: none; z-index: 3000; font-weight: bold; }
        #cert-template { width: 800px; height: 560px; background: white; color: black; position: absolute; left: -9999px; padding: 40px; text-align: center; border: 15px double #8e6d10; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="toast"></div>

    <div class="header">
        <div style="display:flex; gap:15px;"><img id="main-logo" class="logo-img"><img id="main-founder" class="founder-img"></div>
        <div style="font-weight:900; font-size:14px; text-align:center; margin-top:5px;">DON BOSCO POLYTECHNIC COLLEGE<br><span style="color:var(--neon); font-size:11px;">G.O.A.T.S</span></div>
    </div>

    <div id="login-view" class="glass" style="max-width:350px; margin: 40px auto;">
        <select id="user-select"><option disabled selected>Loading Data...</option></select>
        <input type="password" id="pass-input" placeholder="Password">
        <button class="btn-main" onclick="login()">LOGIN</button>
    </div>

    <div id="teacher-view" style="display:none;" class="glass">
        <div style="text-align:center; font-size:10px; color:var(--neon); font-weight:bold;">LIVE SESSION SCOREBOARD</div>
        <div class="session-board">
            <div class="session-box" style="background:var(--bosco)">B: <span id="s-bosco">0</span></div>
            <div class="session-box" style="background:var(--savio)">S: <span id="s-savio">0</span></div>
            <div class="session-box" style="background:var(--ruva)">R: <span id="s-ruva">0</span></div>
            <div class="session-box" style="background:var(--thomas)">T: <span id="s-thomas">0</span></div>
        </div>

        <div style="display:flex; gap:10px; margin:10px 0;">
            <button onclick="setMode('Negative')" id="b-neg" style="flex:1; padding:15px; border-radius:12px; background:#ff416c; color:white; border:none; font-weight:900;">-5 pts</button>
            <button onclick="setMode('Positive')" id="b-pos" style="flex:1; padding:15px; border-radius:12px; background:#00b09b; color:white; border:3px solid var(--neon); font-weight:900;">+10 pts</button>
        </div>

        <button id="cam-btn" class="btn-main" onclick="toggleCamera()">SCAN STUDENT QR</button>
        <div id="reader" style="display:none; margin:15px 0; border-radius:15px; overflow:hidden; border:2px solid var(--neon);"></div>

        <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:15px; margin-top:15px;">
            <p style="text-align:center; font-size:11px; color:#aaa;">MANUAL ENTRY (IF QR MISSED)</p>
            <input type="text" id="manual-name" placeholder="Student Name">
            <select id="manual-dept"><option disabled selected>Select Dept</option></select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="manualSubmit('Bosco')" style="background:var(--bosco); padding:12px; border:none; border-radius:8px; font-weight:900;">BOSCO</button>
                <button onclick="manualSubmit('Savio')" style="background:var(--savio); padding:12px; border:none; border-radius:8px; font-weight:900;">SAVIO</button>
                <button onclick="manualSubmit('Ruva')" style="background:var(--ruva); padding:12px; border:none; border-radius:8px; font-weight:900;">RUVA</button>
                <button onclick="manualSubmit('Thomas')" style="background:var(--thomas); padding:12px; border:none; border-radius:8px; font-weight:900;">THOMAS</button>
            </div>
        </div>

        <input type="text" id="t-name" style="margin-top:20px;" placeholder="Teacher Name">
        <select id="p-cat"><option>Quiz/Program</option><option>YouTube</option><option>Assembly</option><option>Discipline</option></select>
        <button class="btn-main" style="background:#333; color:white;" onclick="location.reload()">LOGOUT</button>
    </div>

    <div id="admin-view" style="display:none;" class="glass">
        <div id="admin-content"></div>
        <button class="btn-main" onclick="location.reload()">LOGOUT</button>
    </div>

    <div id="cert-template">
        <div style="display:flex; justify-content:space-between; align-items:center;"><img id="cert-logo" height="80"><img id="cert-founder" height="80" style="border-radius:50%"></div>
        <h1 style="font-size:32px; margin-top:20px;">DON BOSCO POLYTECHNIC COLLEGE</h1>
        <h2 style="font-family:'Great Vibes'; font-size:55px; color:#8e6d10; margin:10px 0;">Certificate of Achievement</h2>
        <p style="font-size:22px;">This is to certify that</p>
        <h2 id="pdf-name" style="font-size:42px; text-decoration:underline;"></h2>
        <p style="font-size:22px;">has been recognized as</p>
        <h3 id="pdf-award" style="font-size:28px; color:#8e6d10;"></h3>
        <div style="display:flex; justify-content:space-between; margin-top:60px; padding:0 50px;">
            <div style="border-top:2px solid #000; width:160px; font-weight:bold; padding-top:5px;">HOD</div>
            <div style="border-top:2px solid #000; width:160px; font-weight:bold; padding-top:5px;">PRINCIPAL</div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "PASTE_YOUR_DEPLOYED_WEB_APP_URL_HERE";
        let sessionScore = { Bosco:0, Savio:0, Ruva:0, Thomas:0 };
        let currentMode = "Positive", html5QrCode = null;

        async function api(p, b = null) {
            const u = new URL(WEB_APP_URL);
            Object.keys(p).forEach(k => u.searchParams.append(k, p[k]));
            const r = await fetch(u, { method: b ? 'POST' : 'GET', body: b ? JSON.stringify(b) : null, redirect: 'follow' });
            return await r.json();
        }

        window.onload = async () => {
            const i = await api({action:'getImages'});
            document.body.style.backgroundImage = `url('${i.thumbBg}')`;
            document.getElementById('main-logo').src = i.thumbLogo;
            document.getElementById('main-founder').src = i.thumbFounder;
            document.getElementById('cert-logo').src = i.fullLogo;
            document.getElementById('cert-founder').src = i.fullFounder;
            const d = await api({action:'getDeptList'});
            const s = document.getElementById('user-select');
            const ms = document.getElementById('manual-dept');
            s.innerHTML = '<option disabled selected>Select Dept</option>';
            d.forEach(x => { s.add(new Option(x, x)); ms.add(new Option(x, x)); });
        };

        function setMode(m) {
            currentMode = m;
            document.getElementById('b-pos').style.border = m === 'Positive' ? '3px solid var(--neon)' : 'none';
            document.getElementById('b-neg').style.border = m === 'Negative' ? '3px solid var(--neon)' : 'none';
        }

        async function login() {
            const u = document.getElementById('user-select').value, p = document.getElementById('pass-input').value;
            const r = await api({}, {action:'authenticate', user:u, pass:p});
            if (r.success) {
                document.getElementById('login-view').style.display = 'none';
                if (r.role === 'Admin') { document.getElementById('admin-view').style.display='block'; loadAdmin(); }
                else { document.getElementById('teacher-view').style.display='block'; }
            } else alert("Access Denied");
        }

        async function toggleCamera() {
            if (!html5QrCode) {
                document.getElementById('reader').style.display = 'block';
                html5QrCode = new Html5Qrcode("reader");
                await html5QrCode.start({facingMode:"environment"}, {fps:15, qrbox:250}, (t) => {
                    const parts = t.split('|'); 
                    if (parts.length >= 3) { processEntry(parts[0], parts[1], parts[2]); stopCam(); }
                });
                document.getElementById('cam-btn').innerText = "STOP CAMERA";
            } else stopCam();
        }

        async function stopCam() {
            if (html5QrCode) { await html5QrCode.stop(); await html5QrCode.clear(); html5QrCode = null; }
            document.getElementById('reader').style.display = 'none';
            document.getElementById('cam-btn').innerText = "SCAN STUDENT QR";
        }

        function manualSubmit(h) {
            const n = document.getElementById('manual-name').value;
            const d = document.getElementById('manual-dept').value;
            if(!n || !d) return alert("Fill Name and Dept!");
            processEntry(n, d, h);
            document.getElementById('manual-name').value = "";
        }

        async function processEntry(n, d, h) {
            const t = document.getElementById('t-name').value;
            if (!t) return alert("Enter Teacher Name!");
            showToast("Syncing...");
            const r = await api({}, {action:'submitPoint', payload:{dept:d, studentName:n, house:h, teacherName:t, category:document.getElementById('p-cat').value, type:currentMode}});
            if (r.success) {
                const p = currentMode === 'Positive' ? 10 : -5;
                sessionScore[h] += p;
                document.getElementById('s-'+h.toLowerCase()).innerText = sessionScore[h];
                if (p > 0) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                showToast("Points Logged for " + n);
            }
        }

        async function loadAdmin() {
            const d = await api({action:'getAdminData'});
            let h = `<h2 style="color:var(--neon); text-align:center;">ANNUAL HOUSE RANKING</h2>`;
            const m = ["ðŸ† WINNER", "ðŸ¥ˆ RUNNER", "ðŸ¥‰ 2nd RUNNER", "ðŸŽ—ï¸ 4th"];
            d.houseRank.forEach((r, i) => h += `<div class="stat-card"><b>${m[i]}:</b> ${r[0]} (${r[1]} pts)</div>`);

            h += `<div class="stat-card" style="border-left-color:var(--savio)"><b>WEEKLY TOP HOUSE:</b> ${d.weeklyTopHouse}</div>`;

            h += `<h3 style="color:var(--neon); margin-top:20px;">WEEKLY DEPT TOPPERS (Ties Incl.)</h3>`;
            for (let dept in d.weeklyToppers) {
                h += `<div class="glass"><b>${dept}</b>`;
                d.weeklyToppers[dept].forEach(s => {
                    h += `<div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-top:5px;">
                        <span>${s[0]} (${s[1]} pts)</span>
                        <button style="color:var(--neon); background:none; border:1px solid; border-radius:4px; padding:2px 5px;" onclick="genPDF('${s[0]}','Weekly Topper - ${dept}')">CERT</button>
                    </div>`;
                });
                h += `</div>`;
            }

            h += `<h3 style="color:var(--thomas); margin-top:20px;">ANNUAL TOP 3 PER DEPT</h3>`;
            for (let dept in d.annualDeptRankings) {
                h += `<div class="glass"><b>${dept}</b>`;
                d.annualDeptRankings[dept].forEach((s, idx) => {
                    h += `<div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; margin-top:5px;">
                        <span>${idx+1}. ${s[0]} (${s[1]} pts)</span>
                        <button style="color:var(--thomas); background:none; border:1px solid; border-radius:4px; padding:2px 5px;" onclick="genPDF('${s[0]}','${idx+1}${idx==0?'st':idx==1?'nd':'rd'} Place Annual - ${dept}')">CERT</button>
                    </div>`;
                });
                h += `</div>`;
            }
            document.getElementById('admin-content').innerHTML = h;
        }

        async function genPDF(n, a) {
            document.getElementById('pdf-name').innerText = n;
            document.getElementById('pdf-award').innerText = a;
            const c = await html2canvas(document.getElementById('cert-template'), {scale:3, useCORS:true});
            const p = new jspdf.jsPDF('l', 'mm', 'a4');
            p.addImage(c.toDataURL('image/png'), 'PNG', 0, 0, 297, 210);
            p.save(n + "_Award.pdf");
        }

        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none', 2000); }
    </script>
</body>
</html>
