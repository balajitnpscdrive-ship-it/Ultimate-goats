<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DB-GOATS</title>
    
    <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=18pAKHffTYVmymmTmWgJS0S4sAE5XlMfQ">
    <link rel="icon" type="image/png" href="https://drive.google.com/uc?export=view&id=18pAKHffTYVmymmTmWgJS0S4sAE5XlMfQ">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22DB%20GOATS%22,%22display%22:%22standalone%22,%22background_color%22:%22%23000000%22,%22icons%22:[{%22src%22:%22https://drive.google.com/uc?export=view&id=18pAKHffTYVmymmTmWgJS0S4sAE5XlMfQ%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&family=Great+Vibes&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root { --bosco: #ff0055; --savio: #00d4ff; --ruva: #ffcc00; --thomas: #00ff88; --neon: #fbff00; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: #000 center fixed no-repeat; background-size: cover; color: white; min-height: 100vh; }
        .glass { background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); border-radius: 20px; padding: 15px; margin: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .header { display: flex; flex-direction: column; align-items: center; padding: 15px; border-bottom: 2px solid var(--neon); background: rgba(0,0,0,0.95); position: sticky; top:0; z-index:100; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #1a1a1a; color: white; border: 1px solid #333; border-radius: 12px; font-size: 16px; }
        .btn-main { width: 100%; padding: 16px; border-radius: 12px; background: var(--neon); color: black; font-weight: 900; border: none; cursor: pointer; }
        .session-box { flex: 1; padding: 8px; border-radius: 8px; text-align: center; color: black; font-weight: 900; font-size: 11px; }
        .stat-card { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin: 10px 0; border-left: 5px solid var(--neon); }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--neon); color: black; padding: 12px 25px; border-radius: 50px; display: none; z-index: 1000; font-weight: bold; }
        #cert-template { width: 800px; height: 560px; background: white; color: black; position: absolute; left: -9999px; padding: 40px; text-align: center; border: 15px double #8e6d10; }
    </style>
</head>
<body>
    <div id="toast"></div>

    <div class="header">
        <div style="display:flex; gap:15px;"><img id="m-logo" height="45"><img id="m-founder" height="45" style="border-radius:50%; border:2px solid var(--neon);"></div>
        <div style="font-weight:900; font-size:13px; text-align:center; margin-top:5px;">DON BOSCO POLYTECHNIC COLLEGE<br><span style="color:var(--neon); font-size:10px;">G.O.A.T.S LEADERBOARD</span></div>
    </div>

    <div id="login-view" class="glass" style="max-width:320px; margin: 40px auto;">
        <select id="user-select"><option>Connecting...</option></select>
        <input type="password" id="pass-input" placeholder="Password">
        <button class="btn-main" onclick="login()">LOGIN</button>
    </div>

    <div id="teacher-view" style="display:none;" class="glass">
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <div class="session-box" style="background:var(--bosco)">B: <span id="s-bosco">0</span></div>
            <div class="session-box" style="background:var(--savio)">S: <span id="s-savio">0</span></div>
            <div class="session-box" style="background:var(--ruva)">R: <span id="s-ruva">0</span></div>
            <div class="session-box" style="background:var(--thomas)">T: <span id="s-thomas">0</span></div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onclick="setM('Negative')" id="b-neg" style="flex:1; background:#ff416c; padding:15px; border-radius:12px; border:none; color:white; font-weight:900;">-5 PTS</button>
            <button onclick="setM('Positive')" id="b-pos" style="flex:1; background:#00b09b; padding:15px; border-radius:12px; border:3px solid var(--neon); color:white; font-weight:900;">+10 PTS</button>
        </div>

        <button class="btn-main" onclick="toggleCam()" id="cam-btn">SCAN STUDENT QR</button>
        <div id="reader" style="display:none; margin:15px 0; border-radius:15px; overflow:hidden; border:2px solid var(--neon);"></div>

        <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <input type="text" id="m-name" placeholder="Manual Student Name">
            <select id="m-dept"><option disabled selected>Select Dept</option></select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                <button onclick="mSub('Bosco')" style="background:var(--bosco); border:none; padding:12px; border-radius:8px; font-weight:900;">BOSCO</button>
                <button onclick="mSub('Savio')" style="background:var(--savio); border:none; padding:12px; border-radius:8px; font-weight:900;">SAVIO</button>
                <button onclick="mSub('Ruva')" style="background:var(--ruva); border:none; padding:12px; border-radius:8px; font-weight:900;">RUVA</button>
                <button onclick="mSub('Thomas')" style="background:var(--thomas); border:none; padding:12px; border-radius:8px; font-weight:900;">THOMAS</button>
            </div>
        </div>

        <input type="text" id="t-name" placeholder="Teacher Name (Req)" style="margin-top:20px;">
        <select id="p-cat">
            <option>YouTube Contribution</option>
            <option>Discipline</option>
            <option>Sports/Cultural</option>
            <option>Academics</option>
        </select>
        <button class="btn-main" style="background:#333; color:white; margin-top:20px;" onclick="location.reload()">LOGOUT</button>
    </div>

    <div id="admin-view" style="display:none;" class="glass">
        <div id="admin-data"></div>
        <button class="btn-main" onclick="location.reload()">LOGOUT</button>
    </div>

    <div id="cert-template">
        <div style="display:flex; justify-content:space-between;"><img id="c-logo" height="65"><img id="c-founder" height="65" style="border-radius:50%"></div>
        <h2 style="font-family:'Great Vibes'; font-size:45px; color:#8e6d10; margin:20px 0;">Certificate of Achievement</h2>
        <p style="font-size:18px;">Awarded to</p>
        <h1 id="pdf-n" style="font-size:38px; text-decoration:underline; margin:10px 0;"></h1>
        <p id="pdf-a" style="font-size:22px; font-weight:bold; color:#8e6d10;"></p>
        <div style="margin-top:60px; display:flex; justify-content:space-around; font-weight:bold;">
            <div style="border-top:2px solid #000; width:180px; padding-top:5px;">HOD</div>
            <div style="border-top:2px solid #000; width:180px; padding-top:5px;">PRINCIPAL</div>
        </div>
    </div>

    <script>
        const URL = "https://script.google.com/macros/s/AKfycbwjBM4BsNqA_P5sVSWVOMDf7sV0dOZqDUpeBfpHoknhJ9Uk8p1IShezpk1TaOtUPXcE/exec";
        let sessionScore = { Bosco:0, Savio:0, Ruva:0, Thomas:0 }, mode = "Positive", html5QrCode = null;

        async function api(p, b = null) {
            const u = new window.URL(URL);
            if(p) Object.keys(p).forEach(k => u.searchParams.append(k, p[k]));
            const r = await fetch(u, { method: b ? 'POST' : 'GET', body: b ? JSON.stringify(b) : null });
            return await r.json();
        }

        window.onload = async () => {
            const img = await api({action:'getImages'});
            document.body.style.backgroundImage = `url('${img.bg}')`;
            document.getElementById('m-logo').src = img.logo;
            document.getElementById('m-founder').src = img.founder;
            document.getElementById('c-logo').src = img.logo;
            document.getElementById('c-founder').src = img.founder;

            const depts = await api({action:'getDeptList'});
            const s = document.getElementById('user-select'), md = document.getElementById('m-dept');
            s.innerHTML = '<option disabled selected>Select User</option>';
            depts.forEach(x => { s.add(new Option(x, x)); md.add(new Option(x, x)); });
        };

        async function login() {
            const u = document.getElementById('user-select').value, p = document.getElementById('pass-input').value;
            const r = await api({}, {action:'authenticate', user:u, pass:p});
            if (r.success) {
                document.getElementById('login-view').style.display = 'none';
                if (r.role === 'Admin') { document.getElementById('admin-view').style.display='block'; loadAdmin(); }
                else { document.getElementById('teacher-view').style.display='block'; }
            } else alert("Invalid Password");
        }

        function setM(m) {
            mode = m;
            document.getElementById('b-pos').style.border = m === 'Positive' ? '3px solid var(--neon)' : 'none';
            document.getElementById('b-neg').style.border = m === 'Negative' ? '3px solid var(--neon)' : 'none';
        }

        async function process(n, d, h) {
            const t = document.getElementById('t-name').value;
            if(!t) return alert("Teacher Name required!");
            const pts = mode === 'Positive' ? 10 : -5;
            sessionScore[h] += pts;
            document.getElementById('s-'+h.toLowerCase()).innerText = sessionScore[h];
            if(pts > 0) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            showToast("Syncing...");
            api({}, {action:'submitPoint', payload:{dept:d, studentName:n, house:h, teacherName:t, category:document.getElementById('p-cat').value, type:mode}})
            .then(() => showToast("Saved to Cloud"));
        }

        async function mSub(h) {
            const n = document.getElementById('m-name').value, d = document.getElementById('m-dept').value;
            if(!n || !d) return alert("Fill Name & Dept");
            await process(n, d, h);
            document.getElementById('m-name').value = "";
        }

        async function toggleCam() {
            if(!html5QrCode) {
                document.getElementById('reader').style.display = 'block';
                html5QrCode = new Html5Qrcode("reader");
                await html5QrCode.start({facingMode:"environment"}, {fps:20, qrbox:250}, (t) => {
                    const p = t.split('|'); 
                    if(p.length >= 3) { process(p[0], p[1], p[2]); stopC(); }
                });
                document.getElementById('cam-btn').innerText = "STOP SCANNER";
            } else stopC();
        }

        function stopC() {
            if(html5QrCode) { html5QrCode.stop(); html5QrCode = null; }
            document.getElementById('reader').style.display = 'none';
            document.getElementById('cam-btn').innerText = "SCAN STUDENT QR";
        }

        async function loadAdmin() {
            const d = await api({action:'getAdminData'});
            let html = `<h2 style="color:var(--neon); text-align:center;">WEEKLY HOUSE RANKING</h2>`;
            const labels = ["ðŸ† WINNER", "ðŸ¥ˆ RUNNER", "ðŸ¥‰ 2nd RUNNER", "ðŸŽ—ï¸ 4th"];
            d.weeklyHouseRank.forEach((r, i) => html += `<div class="stat-card" style="border-left-color:var(--savio)"><b>${labels[i]}:</b> ${r[0]} (${r[1]} pts)</div>`);
            
            html += `<h3 style="color:var(--neon); margin-top:25px;">WEEKLY ACTIVE DEPTS</h3>`;
            for (let dept in d.weeklyToppers) {
                html += `<div class="glass"><b>${dept}</b>`;
                d.weeklyToppers[dept].forEach(s => {
                    html += `<div style="display:flex; justify-content:space-between; margin-top:8px;">
                        <span>${s[0]} (${s[1]})</span>
                        <button style="color:var(--neon); background:none; border:1px solid; border-radius:4px; padding:2px 5px;" onclick="genPDF('${s[0]}','Weekly Topper - ${dept}')">CERT</button>
                    </div>`;
                });
                html += `</div>`;
            }

            html += `<h2 style="color:var(--ruva); text-align:center; margin-top:35px;">ANNUAL HOUSE RANKING</h2>`;
            d.houseRank.forEach((r, i) => html += `<div class="stat-card" style="border-left-color:var(--ruva)"><b>ANNUAL ${labels[i].split(' ')[1]}:</b> ${r[0]} (${r[1]} pts)</div>`);

            html += `<h3 style="color:var(--thomas); margin-top:25px;">ANNUAL TOP 3 (DEPT)</h3>`;
            for (let dept in d.annualDeptRankings) {
                html += `<div class="glass"><b>${dept}</b>`;
                d.annualDeptRankings[dept].forEach((s, i) => {
                    html += `<div style="display:flex; justify-content:space-between; margin-top:8px;">
                        <span>${i+1}. ${s[0]} (${s[1]})</span>
                        <button style="color:var(--thomas); background:none; border:1px solid; border-radius:4px; padding:2px 5px;" onclick="genPDF('${s[0]}','${i+1}nd Place Annual - ${dept}')">CERT</button>
                    </div>`;
                });
                html += `</div>`;
            }

            html += `<h3 style="color:var(--savio); margin-top:25px;">STAR TEACHERS</h3>`;
            d.starTeachers.forEach(t => html += `<div class="stat-card" style="border-left-color:var(--savio)">${t[0]} (${t[1]} Logs) <button style="float:right;" onclick="genPDF('${t[0]}','Star Teacher of the Week')">CERT</button></div>`);
            
            document.getElementById('admin-data').innerHTML = html;
        }

        async function genPDF(n, a) {
            document.getElementById('pdf-n').innerText = n;
            document.getElementById('pdf-a').innerText = a;
            const canvas = await html2canvas(document.getElementById('cert-template'), {scale:3});
            const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 297, 210);
            pdf.save(n + ".pdf");
        }

        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none', 2000); }
    </script>
</body>
</html>
